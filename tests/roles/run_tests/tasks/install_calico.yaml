# Install Calico
- name: Download Calico manifests
  get_url:
    url: "https://raw.githubusercontent.com/projectcalico/calico/{{ CALICO_VERSION }}/manifests/calico.yaml"
    dest: /tmp/
    mode: '664'
  register: calico_manifest

- name: Replace docker.io with proxy
  ansible.builtin.replace:
    path: /tmp/calico.yaml
    regexp: 'docker.io'
    replace: '{{ DOCKER_HUB_PROXY }}'

- name: Calico IPv4 specific setup
  block:
    - name: Uncomment CALICO_IPV4POOL_CIDR name
      replace:
        path: /tmp/calico.yaml
        regexp: "# - name: CALICO_IPV4POOL_CIDR"
        replace: "- name: CALICO_IPV4POOL_CIDR"

    - name: Uncomment CALICO_IPV4POOL_CIDR value and set POD_CIDR
      replace:
        path: /tmp/calico.yaml
        regexp: '#   value: "192.168.0.0/16"'
        replace: '  value: "{{ POD_CIDR }}"'

    - name: Add IP_AUTODETECTION_METHOD in calico config Ubuntu
      blockinfile:
        path: /tmp/calico.yaml
        insertafter: "{{ POD_CIDR }}"
        block: |
            # for indentation
                        - name: IP_AUTODETECTION_METHOD
                          value: "cidr={{ EXTERNAL_SUBNET_V4_HOST }}/{{ EXTERNAL_SUBNET_V4_PREFIX }}"

  when: IP_STACK == "v4" or IP_STACK == "v4v6"

- name: Calico IPv6 specific setup
  block: 
    - name: Edit IPAM pool
      replace:
        path: /tmp/calico.yaml
        regexp: '"type": "calico-ipam"'
        replace: '"type": "calico-ipam", "assign_ipv4": "false", "assign_ipv6": "true"'

    - name: Add IP_AUTODETECTION_METHOD and POD_CIDR in calico config Ubuntu
      blockinfile:
        path: /tmp/calico.yaml
        insertafter: "{{ POD_CIDR }}"
        block: |
            # for indentation
                        - name: IP_AUTODETECTION_METHOD
                          value: "cidr=127.0.0.1/24"
                        - name: IP6_AUTODETECTION_METHOD
                          value: "cidr={{ EXTERNAL_SUBNET_V6_HOST }}/{{ EXTERNAL_SUBNET_V6_PREFIX }}"
                        - name: IP6
                          value: "autodetect"
                        # CALICO_ROUTER_ID needed when v4 is disabled
                        - name: CALICO_ROUTER_ID
                          value: "hash"

    - name: Disable IPv4 autodetection
      replace:
        path: /tmp/calico.yaml
        after: "name: IP"
        before: "name: CALICO_IPV4POOL_IPIP"
        regexp: "autodetect"
        replace: "none"

    - name: set FELIX_IPV6SUPPORT to true
      replace:
        path: /tmp/calico.yaml
        after: "name: FELIX_IPV6SUPPORT"
        before: "name: FELIX_HEALTHENABLED"
        regexp: "false"
        replace: "true"
  when: IP_STACK == "v6"

- name: Apply Calico manifest
  kubernetes.core.k8s:
    state: present
    src: "/tmp/calico.yaml"
    kubeconfig: "/tmp/kubeconfig-{{ CLUSTER_NAME }}.yaml"
  register: install_cni

- name: Wait (maximum 10 mins) until Calico pods start running
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kube-system
    kubeconfig: /tmp/kubeconfig-{{ CLUSTER_NAME }}.yaml
    field_selectors:
      - status.phase!=Running
  retries: 60
  delay: 10
  register: calico_pods
  until: (calico_pods is succeeded) and
          (calico_pods.resources | length == 0)
