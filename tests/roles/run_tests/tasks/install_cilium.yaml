# Install Cilium CLI
- name: Get latest Cilium CLI version
  ansible.builtin.uri:
    url: https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt
    return_content: yes
  register: cilium_version_response

- name: Set Cilium CLI version and architecture
  ansible.builtin.set_fact:
    CILIUM_CLI_VERSION: "{{ cilium_version_response.content | trim }}"
    CLI_ARCH: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

- name: Download Cilium CLI archive and checksum
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/{{ CILIUM_CLI_VERSION }}/cilium-linux-{{ CLI_ARCH }}.tar.gz{{ item }}"
    dest: "/tmp/cilium-linux-{{ CLI_ARCH }}.tar.gz{{ item }}"
  loop:
    - ""
    - ".sha256sum"

- name: Verify checksum of Cilium CLI archive
  ansible.builtin.stat:
    path: "/tmp/cilium-linux-{{ CLI_ARCH }}.tar.gz"
    checksum_algorithm: sha256
    get_checksum: yes
  register: cilium_archive_stat

- name: Read expected checksum
  ansible.builtin.slurp:
    src: "/tmp/cilium-linux-{{ CLI_ARCH }}.tar.gz.sha256sum"
  register: expected_checksum_file

- name: Extract expected checksum value
  ansible.builtin.set_fact:
    expected_checksum: "{{ (expected_checksum_file.content | b64decode).split()[0] }}"

- name: Verify checksum matches
  ansible.builtin.fail:
    msg: "Checksum verification failed"
  when: cilium_archive_stat.stat.checksum != expected_checksum

- name: Extract Cilium CLI to /usr/local/bin
  ansible.builtin.unarchive:
    src: "/tmp/cilium-linux-{{ CLI_ARCH }}.tar.gz"
    dest: /usr/local/bin
    mode: 0755
  become: true
  become_user: root

- name: Clean up downloaded files
  ansible.builtin.file:
    path: "/tmp/cilium-linux-{{ CLI_ARCH }}.tar.gz{{ item }}"
    state: absent
  loop:
    - ""
    - ".sha256sum"

- name: Check if Cilium is already installed
  ansible.builtin.command:
    cmd: cilium status
  environment:
    KUBECONFIG: /tmp/kubeconfig-{{ CLUSTER_NAME }}.yaml
  register: cilium_status
  failed_when: false
  changed_when: false

- name: Install Cilium using CLI
  ansible.builtin.command:
    cmd: >
      cilium install --version {{ CILIUM_VERSION }}
  environment:
    KUBECONFIG: /tmp/kubeconfig-{{ CLUSTER_NAME }}.yaml
  become: true
  when: cilium_status.rc != 0

- name: Wait (maximum 10 mins) until Cilium pods start running
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kube-system
    kubeconfig: /tmp/kubeconfig-{{ CLUSTER_NAME }}.yaml
    field_selectors:
      - status.phase!=Running
  retries: 60
  delay: 10
  register: cilium_pods
  until: (cilium_pods is succeeded) and
          (cilium_pods.resources | length == 0)
